<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Code Quest: The Dragon's Lair</title>
    <style>
        body {
            font-family: 'Courier New', Courier, monospace;
            background-color: #1e1e1e;
            color: #d4d4d4;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }
        #game-container {
            width: 80%;
            max-width: 800px;
            background-color: #252526;
            border: 1px solid #333;
            padding: 20px;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
            border-radius: 8px;
        }
        h1 {
            color: #569cd6;
            text-align: center;
        }
        #story-text {
            background-color: #1e1e1e;
            padding: 15px;
            border-radius: 4px;
            border-left: 4px solid #ce9178;
            min-height: 80px;
        }
        #code-editor {
            width: 98%;
            height: 150px;
            background-color: #1e1e1e;
            color: #d4d4d4;
            border: 1px solid #333;
            font-size: 16px;
            padding: 10px;
            margin-top: 15px;
        }
        #output-area {
            width: 98%;
            min-height: 40px;
            background-color: #1e1e1e;
            color: #4ec9b0;
            border: 1px solid #333;
            padding: 10px;
            margin-top: 10px;
            font-weight: bold;
        }
        #run-button {
            background-color: #4CAF50;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 15px;
            display: block;
            width: 100%;
        }
        .success { color: #4ec9b0; }
        .error { color: #f44747; }
    </style>
</head>
<body>
    <div id="game-container">
        <h1>Code Quest: The Dragon's Lair üêâ</h1>
        <div id="story-text"></div>
        <textarea id="code-editor" spellcheck="false" placeholder="Type your Python code here..."></textarea>
        <button id="run-button" onclick="runCode()">Run Code</button>
        <pre id="output-area"></pre>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/skulpt@1.2.0/dist/skulpt.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/skulpt@1.2.0/dist/skulpt-stdlib.js"></script>
    
    <script>
        // Game Levels Data
        const levels = [
            {
                story: "You stand at the edge of the Whispering Woods. A magical barrier of shimmering leaves blocks the path. An ancient carving on a nearby stone reads: <em>'Speak the magic words to pass.'</em><br><br><strong>Challenge:</strong> Use the <strong>print()</strong> function to display the magic words: 'OPEN SESAME'",
                validate: (output) => output.trim().toUpperCase() === "OPEN SESAME",
                success: "The leaves rustle and part, revealing a path forward!"
            },
            {
                story: "You face a rickety bridge guarded by a goblin. 'To cross,' he grumbles, 'solve my riddle! I have 50 gold coins, but the toll is 8. Create a variable named <strong>gold</strong> with the value 50, and subtract the 8-coin toll. Then print the final amount.'<br><br><strong>Hint:</strong> result = 50 - 8",
                validate: (output) => output.trim() === "42",
                success: "The goblin nods. 'Correct.' He lets you pass. You now face a giant stone door."
            },
            {
                story: "The inscription on the door says: <em>'I have cities, but no houses. I have mountains, but no trees. I have water, but no fish. What am I?'</em> The answer is 'A MAP'.<br><br><strong>Challenge:</strong> Create a variable named <strong>my_answer</strong> and assign it the correct answer. Then use an <strong>if</strong> statement to check if <strong>my_answer == 'A MAP'</strong>. If it is, print the message 'The door opens'.",
                validate: (output) => output.trim().toLowerCase() === "the door opens",
                success: "Correct! The door rumbles and slowly opens, revealing a room filled with treasure!"
            },
            {
                story: "You're inside! You see a massive pile of gold and a single, ornate treasure chest. A final message glows in the air:<br><br><strong>Congratulations, adventurer! You have proven your skill. You have earned this treasure and the powerful knowledge of code!</strong><br><br>üéâ You have completed Code Quest! üéâ",
                isFinal: true
            }
        ];

        let currentLevel = 0;
        const storyEl = document.getElementById('story-text');
        const codeEl = document.getElementById('code-editor');
        const outputEl = document.getElementById('output-area');
        const buttonEl = document.getElementById('run-button');

        function setupLevel(levelIndex) {
            const level = levels[levelIndex];
            storyEl.innerHTML = level.story;
            codeEl.value = '';
            outputEl.textContent = '';
            outputEl.className = '';
            if (level.isFinal) {
                codeEl.style.display = 'none';
                buttonEl.style.display = 'none';
            }
        }

        function runCode() {
            const userCode = codeEl.value;
            const level = levels[currentLevel];
            outputEl.textContent = ''; 

            Sk.configure({
                output: (text) => {
                    outputEl.textContent += text;
                },
                read: (x) => {
                    if (Sk.builtinFiles === undefined || Sk.builtinFiles["files"][x] === undefined)
                        throw "File not found: '" + x + "'";
                    return Sk.builtinFiles["files"][x];
                }
            });

            (Sk.TurtleGraphics || (Sk.TurtleGraphics = {})).target = 'mycanvas';

            try {
                Sk.misceval.asyncToPromise(() => {
                    return Sk.importMainWithBody("<stdin>", false, userCode, true);
                }).then(() => {
                    // Check the answer after code runs successfully
                    if (level.validate(outputEl.textContent)) {
                        outputEl.className = 'success';
                        outputEl.textContent = "SUCCESS! " + level.success;
                        currentLevel++;
                        if (currentLevel < levels.length) {
                            setTimeout(() => setupLevel(currentLevel), 3000);
                        }
                    } else {
                        outputEl.className = 'error';
                        outputEl.textContent = "Not quite! Check your code and try again. Output was: " + outputEl.textContent;
                    }
                });
            } catch (e) {
                outputEl.className = 'error';
                outputEl.textContent = e.toString();
            }
        }
        
        // Start the game
        setupLevel(currentLevel);
    </script>
</body>
</html>